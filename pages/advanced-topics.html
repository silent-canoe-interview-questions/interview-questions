<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Topics - Learn Microsoft SQL Server</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">
    <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">SQL Tutorial</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="basics.html">Basics</a></li>
                    <li class="nav-item"><a class="nav-link" href="data-manipulation.html">Data Manipulation</a></li>
                    <li class="nav-item"><a class="nav-link active" href="advanced-topics.html">Advanced Topics</a></li>
                    <li class="nav-item"><a class="nav-link" href="examples.html">Examples</a></li>
                    <li class="nav-item"><a class="nav-link" href="best-practices.html">Best Practices</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-5 pt-4">
        <h1 class="mb-4">Advanced SQL Topics</h1>

        <section id="joins" class="mb-5">
            <h2>JOINs and Table Relationships</h2>
            <p>JOINs are used to combine rows from two or more tables based on a related column between them.</p>

            <h3>Types of JOINs</h3>
            <div class="row mb-4">
                <div class="col-md-6">
                    <img src="https://www.w3schools.com/sql/img_innerjoin.gif" alt="INNER JOIN" class="img-fluid mb-3">
                    <h4>INNER JOIN</h4>
                    <pre><code class="language-sql">SELECT o.OrderID, c.CustomerName
FROM Orders o
INNER JOIN Customers c 
    ON o.CustomerID = c.CustomerID;</code></pre>
                </div>
                <div class="col-md-6">
                    <img src="https://www.w3schools.com/sql/img_leftjoin.gif" alt="LEFT JOIN" class="img-fluid mb-3">
                    <h4>LEFT JOIN</h4>
                    <pre><code class="language-sql">SELECT e.FirstName, d.DepartmentName
FROM Employees e
LEFT JOIN Departments d
    ON e.DepartmentID = d.DepartmentID;</code></pre>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <img src="https://www.w3schools.com/sql/img_rightjoin.gif" alt="RIGHT JOIN" class="img-fluid mb-3">
                    <h4>RIGHT JOIN</h4>
                    <pre><code class="language-sql">SELECT e.FirstName, d.DepartmentName
FROM Employees e
RIGHT JOIN Departments d
    ON e.DepartmentID = d.DepartmentID;</code></pre>
                </div>
                <div class="col-md-6">
                    <img src="https://www.w3schools.com/sql/img_fulljoin.gif" alt="FULL JOIN" class="img-fluid mb-3">
                    <h4>FULL JOIN</h4>
                    <pre><code class="language-sql">SELECT e.FirstName, d.DepartmentName
FROM Employees e
FULL JOIN Departments d
    ON e.DepartmentID = d.DepartmentID;</code></pre>
                </div>
            </div>
        </section>

        <section id="subqueries" class="mb-5">
            <h2>Subqueries</h2>
            <p>A subquery is a query nested inside another query. They can be used in various parts of a SQL statement.</p>

            <h3>Types of Subqueries</h3>
            
            <h4>Single-Row Subquery</h4>
            <pre><code class="language-sql">-- Find employees who earn more than the average salary
SELECT FirstName, LastName, Salary
FROM Employees
WHERE Salary > (
    SELECT AVG(Salary)
    FROM Employees
);</code></pre>

            <h4>Multiple-Row Subquery</h4>
            <pre><code class="language-sql">-- Find departments that have employees earning over 50000
SELECT DepartmentName
FROM Departments
WHERE DepartmentID IN (
    SELECT DISTINCT DepartmentID
    FROM Employees
    WHERE Salary > 50000
);</code></pre>

            <h4>Correlated Subquery</h4>
            <pre><code class="language-sql">-- Find employees who earn more than their department's average
SELECT e.FirstName, e.LastName, e.Salary
FROM Employees e
WHERE Salary > (
    SELECT AVG(Salary)
    FROM Employees
    WHERE DepartmentID = e.DepartmentID
);</code></pre>
        </section>

        <section id="stored-procedures" class="mb-5">
            <h2>Stored Procedures</h2>
            <p>Stored procedures are prepared SQL statements that can be reused over and over again.</p>

            <h3>Creating Stored Procedures</h3>
            <pre><code class="language-sql">CREATE PROCEDURE GetEmployeesByDepartment
    @DepartmentID INT,
    @MinSalary DECIMAL(10,2) = NULL
AS
BEGIN
    SELECT 
        FirstName,
        LastName,
        Salary
    FROM Employees
    WHERE DepartmentID = @DepartmentID
    AND (@MinSalary IS NULL OR Salary >= @MinSalary)
END;</code></pre>

            <h3>Executing Stored Procedures</h3>
            <pre><code class="language-sql">-- Execute with required parameter
EXEC GetEmployeesByDepartment @DepartmentID = 1;

-- Execute with both parameters
EXEC GetEmployeesByDepartment 
    @DepartmentID = 1, 
    @MinSalary = 50000;</code></pre>

            <h3>Benefits of Stored Procedures</h3>
            <ul>
                <li>Improved performance through cached execution plans</li>
                <li>Reduced network traffic</li>
                <li>Better security through encapsulation</li>
                <li>Code reusability and maintenance</li>
            </ul>
        </section>

        <section id="transactions" class="mb-5">
            <h2>Transactions</h2>
            <p>Transactions ensure data integrity by grouping multiple SQL operations into a single unit of work.</p>

            <h3>ACID Properties</h3>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Atomicity</td>
                            <td>All operations complete successfully, or none of them do</td>
                        </tr>
                        <tr>
                            <td>Consistency</td>
                            <td>Data remains in a consistent state before and after the transaction</td>
                        </tr>
                        <tr>
                            <td>Isolation</td>
                            <td>Transactions operate independently of each other</td>
                        </tr>
                        <tr>
                            <td>Durability</td>
                            <td>Changes made by committed transactions are permanent</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Transaction Example</h3>
            <pre><code class="language-sql">BEGIN TRY
    BEGIN TRANSACTION;
        
        -- Withdraw money from account 1
        UPDATE BankAccounts
        SET Balance = Balance - 1000
        WHERE AccountID = 1;
        
        -- Deposit money to account 2
        UPDATE BankAccounts
        SET Balance = Balance + 1000
        WHERE AccountID = 2;
        
        -- If both updates succeed, commit the transaction
        COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    -- If any error occurs, rollback the transaction
    ROLLBACK TRANSACTION;
    
    -- Log or handle the error
    SELECT 
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_MESSAGE() AS ErrorMessage;
END CATCH;</code></pre>
        </section>

        <section id="triggers" class="mb-5">
            <h2>Triggers</h2>
            <p>Triggers are special stored procedures that automatically execute when specific events occur in a database.</p>

            <h3>Types of Triggers</h3>
            <ul>
                <li>DML Triggers (INSERT, UPDATE, DELETE)</li>
                <li>DDL Triggers (CREATE, ALTER, DROP)</li>
                <li>LOGON Triggers</li>
            </ul>

            <h3>Example Trigger</h3>
            <pre><code class="language-sql">CREATE TRIGGER trg_UpdateAudit
ON Employees
AFTER UPDATE
AS
BEGIN
    INSERT INTO EmployeeAudit (
        EmployeeID,
        FieldChanged,
        OldValue,
        NewValue,
        UpdateDate
    )
    SELECT
        i.EmployeeID,
        'Salary',
        d.Salary,
        i.Salary,
        GETDATE()
    FROM inserted i
    INNER JOIN deleted d ON i.EmployeeID = d.EmployeeID
    WHERE i.Salary <> d.Salary;
END;</code></pre>
        </section>

        <section id="practice" class="mb-5">
            <h2>Practice Exercise</h2>
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Exercise: Order Management System</h3>
                    <p>Create a complete order management system using the following requirements:</p>
                    
                    <ol>
                        <li>Create tables for Customers, Orders, and OrderDetails</li>
                        <li>Create a stored procedure to place new orders</li>
                        <li>Implement a trigger to update inventory</li>
                        <li>Write a transaction to process the order</li>
                    </ol>

                    <button class="btn btn-primary mt-3" data-bs-toggle="collapse" data-bs-target="#solution1">
                        Show Solution
                    </button>
                    
                    <div class="collapse mt-3" id="solution1">
                        <pre><code class="language-sql">-- Create tables
CREATE TABLE Customers (
    CustomerID INT PRIMARY KEY IDENTITY(1,1),
    Name NVARCHAR(100),
    Email NVARCHAR(100)
);

CREATE TABLE Orders (
    OrderID INT PRIMARY KEY IDENTITY(1,1),
    CustomerID INT FOREIGN KEY REFERENCES Customers(CustomerID),
    OrderDate DATETIME DEFAULT GETDATE(),
    TotalAmount DECIMAL(10,2)
);

CREATE TABLE OrderDetails (
    OrderDetailID INT PRIMARY KEY IDENTITY(1,1),
    OrderID INT FOREIGN KEY REFERENCES Orders(OrderID),
    ProductID INT,
    Quantity INT,
    UnitPrice DECIMAL(10,2)
);

-- Create stored procedure for placing orders
CREATE PROCEDURE PlaceOrder
    @CustomerID INT,
    @ProductID INT,
    @Quantity INT,
    @UnitPrice DECIMAL(10,2)
AS
BEGIN
    BEGIN TRY
        BEGIN TRANSACTION;
            
            -- Create the order
            INSERT INTO Orders (CustomerID, TotalAmount)
            VALUES (@CustomerID, @Quantity * @UnitPrice);
            
            DECLARE @OrderID INT = SCOPE_IDENTITY();
            
            -- Add order details
            INSERT INTO OrderDetails (OrderID, ProductID, Quantity, UnitPrice)
            VALUES (@OrderID, @ProductID, @Quantity, @UnitPrice);
            
            -- Update inventory (trigger will handle this)
            
            COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH;
END;</code></pre>
                    </div>
                </div>
            </div>
        </section>

        <div class="navigation-buttons d-flex justify-content-between mt-5">
            <a href="data-manipulation.html" class="btn btn-secondary">&larr; Previous: Data Manipulation</a>
            <a href="examples.html" class="btn btn-primary">Next: Examples &rarr;</a>
        </div>
    </main>

    <footer class="bg-light mt-5 py-3">
        <div class="container text-center">
            <p>© 2025 SQL Tutorial. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
    <script src="../scripts/main.js"></script>
</body>
</html>